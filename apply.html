<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Apply — Srivaari Capital</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">

    <header class="header">
      <div class="brand"><div class="logo">S</div>
        <div><div style="font-weight:800">Srivaari Capital</div>
          <div style="font-size:13px;color:var(--muted)">Trusted Personal Finance</div>
        </div>
      </div>
      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="services.html">Services</a>
        <a href="apply.html">Apply</a>
        <a href="contact.html">Contact</a>
      </nav>
    </header>

    <section class="section card">
      <h2>Apply for Loan</h2>
      <p class="small">You must be logged in to submit your loan application.</p>

      <form id="loanForm">

        <label>Full name<input name="name" required /></label>
        <label>Phone<input name="phone" required /></label>
        <label>Email (optional)<input name="email" /></label>
        <label>Loan amount (₹)<input name="loan_amount" type="number" required /></label>
        <label>Tenure (months)<input name="tenure" type="number" required /></label>
        <label>Purpose<textarea name="purpose"></textarea></label>

        <div style="margin-top:12px;display:flex;gap:10px">
          <button class="btn btn-primary" type="submit">Submit</button>
          <a class="btn btn-outline" href="login.html">Login/Signup</a>
        </div>

        <div id="result" style="margin-top:12px;color:var(--muted)"></div>
      </form>
    </section>

    <footer class="footer">© <span id="yr"></span> Srivaari Capital</footer>
  </div>

  <script>
    document.getElementById('yr').textContent = new Date().getFullYear();

    const BACKEND = 'https://srivaari-capital-backend.onrender.com';

    async function checkLogin() {
      try {
        const r = await fetch(BACKEND + '/api/me', {
          credentials: 'include'
        });
        const json = await r.json();
        return json.loggedIn;
      } catch (err) {
        return false;
      }
    }

    document.getElementById('loanForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();

      const loggedIn = await checkLogin();
      if (!loggedIn) {
        document.getElementById('result').textContent = 'You must login first.';
        return;
      }

      document.getElementById('result').textContent = 'Submitting...';

      const f = ev.target;
      const payload = {
        name: f.name.value,
        phone: f.phone.value,
        email: f.email.value,
        loan_amount: f.loan_amount.value,
        tenure: f.tenure.value,
        purpose: f.purpose.value
      };

      try {
        const res = await fetch(BACKEND + '/api/apply', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        const json = await res.json();
        if (res.ok && json.success) {
          document.getElementById('result').textContent =
            'Application submitted. Reference ID: ' + json.id;
          f.reset();
        } else {
          document.getElementById('result').textContent = json.error;
        }
      } catch (err) {
        document.getElementById('result').textContent = 'Network error.';
      }
    });
  </script>
</body>
</html>

